// Hlavn√≠ aplikaƒçn√≠ logika - MyConnectAI v3.2
// Verze: 3.3 - S podporou v≈°ech provider≈Ø

const APP_VERSION = "3.3";

// Glob√°ln√≠ promƒõnn√©
let messages = [];
let rateLimitCounter = 0;
let rateLimitTimer = null;

// Odesl√°n√≠ zpr√°vy s vylep≈°en√Ωm error handling
async function sendMessage() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const messageText = chatInput.value.trim();
    
    if (!messageText) return;
    
    // Kontrola d√©lky zpr√°vy
    if (messageText.length > CONFIG.VALIDATION.MAX_MESSAGE_LENGTH) {
        if (window.uiManager) {
            window.uiManager.addMessage('error', 
                `Zpr√°va je p≈ô√≠li≈° dlouh√°. Maximum je ${CONFIG.VALIDATION.MAX_MESSAGE_LENGTH} znak≈Ø.`
            );
        }
        return;
    }
    
    // Kontrola rate limitingu
    if (CONFIG.RATE_LIMITING.ENABLED && !checkRateLimit()) {
        if (window.uiManager) {
            window.uiManager.addMessage('system', CONFIG.RATE_LIMITING.COOLDOWN_MESSAGE);
        }
        return;
    }
    
    // Kontrola, zda je vybr√°n model s API kl√≠ƒçem
    const activeModel = window.modelManager?.getActiveModel();
    if (!activeModel) {
        if (window.uiManager) {
            window.uiManager.addMessage('error', 'Nen√≠ vybr√°n ≈æ√°dn√Ω AI model. Pros√≠m nastavte model v nastaven√≠.');
        }
        return;
    }
    
    // Pou≈æ√≠t sync verzi pro rychlou kontrolu
    const modelInfo = window.modelManager?.getModelInfoSync();
    if (!modelInfo?.hasApiKey) {
        if (window.uiManager) {
            window.uiManager.addMessage('error', 
                `Pro model ${modelInfo.name} nen√≠ nastaven API kl√≠ƒç. Pros√≠m nastavte ho v nastaven√≠.`
            );
        }
        return;
    }
    
    // P≈ôidat u≈æivatelovu zpr√°vu
    if (window.uiManager) {
        window.uiManager.addMessage('user', messageText);
    }
    messages.push({ role: 'user', content: messageText });
    
    // Vyƒçistit input a nastavit loading stav
    chatInput.value = '';
    chatInput.style.height = 'auto';
    chatInput.style.overflowY = 'hidden';
    chatInput.disabled = true;
    sendButton.disabled = true;
    sendButton.textContent = CONFIG.MESSAGES.LOADING;
    
    // P≈ôidat loading indik√°tor
    const loadingMessage = `${CONFIG.MESSAGES.LOADING} (${modelInfo?.name || 'AI'})`;
    if (window.uiManager) {
        window.uiManager.addMessage('system', loadingMessage);
    }
    
    try {
        // Pou≈æ√≠t Model Manager pro odesl√°n√≠ zpr√°vy
        const response = await window.modelManager.sendMessage(messages);
        
        // P≈ôidat odpovƒõƒè
        if (window.uiManager) {
            window.uiManager.addMessage('assistant', response);
        }
        messages.push({ role: 'assistant', content: response });
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        
        let errorMessage = CONFIG.MESSAGES.ERROR;
        
        // Specifick√© chybov√© hl√°≈°ky podle typu chyby
        if (error instanceof window.APIError) {
            switch (error.details.statusCode) {
                case 401:
                    errorMessage = 'Neplatn√Ω API kl√≠ƒç. Zkontrolujte nastaven√≠.';
                    break;
                case 429:
                    errorMessage = 'P≈ôekroƒçen limit po≈æadavk≈Ø. Zkuste to za chv√≠li.';
                    break;
                case 503:
                    errorMessage = 'Slu≈æba je doƒçasnƒõ nedostupn√°. Zkuste to pozdƒõji.';
                    break;
                default:
                    errorMessage = error.message;
            }
        } else if (error instanceof window.ConfigurationError) {
            if (error.code === 'NO_API_KEY') {
                errorMessage = CONFIG.MESSAGES.NO_API_KEY;
            } else {
                errorMessage = `Chyba konfigurace: ${error.message}`;
            }
        } else if (error instanceof window.ModelError) {
            switch (error.code) {
                case 'TIMEOUT':
                    errorMessage = 'Po≈æadavek vypr≈°el - AI server neodpov√≠d√°.';
                    break;
                case 'NETWORK_ERROR':
                    errorMessage = CONFIG.MESSAGES.CONNECTION_ERROR;
                    break;
                case 'CORS_ERROR':
                    errorMessage = 'Tento AI provider nelze volat p≈ô√≠mo z prohl√≠≈æeƒçe. Zkuste jin√Ω model.';
                    break;
                default:
                    errorMessage = error.message;
            }
        } else {
            errorMessage = error.message || CONFIG.MESSAGES.ERROR;
        }
        
        if (window.uiManager) {
            window.uiManager.addMessage('error', errorMessage);
        }
    } finally {
        // Obnovit UI
        chatInput.disabled = false;
        sendButton.disabled = false;
        sendButton.textContent = CONFIG.UI.SEND_BUTTON_TEXT || 'Odeslat';
        chatInput.focus();
    }
}

// Rate limiting kontrola
function checkRateLimit() {
    if (!CONFIG.RATE_LIMITING.ENABLED) return true;
    
    rateLimitCounter++;
    
    if (!rateLimitTimer) {
        rateLimitTimer = setTimeout(() => {
            rateLimitCounter = 0;
            rateLimitTimer = null;
        }, 60000); // Reset po minutƒõ
    }
    
    return rateLimitCounter <= CONFIG.RATE_LIMITING.MAX_MESSAGES_PER_MINUTE;
}

// Vyƒçistit chat a zaƒç√≠t znovu
function clearChat() {
    messages = [];
    if (window.uiManager) {
        window.uiManager.clearChat();
        window.uiManager.showWelcomeScreen();
    }
}

// Inicializace aplikace s lep≈°√≠ kontrolou z√°vislost√≠
async function initApp() {
    console.log('üöÄ Starting MyConnectAI v' + APP_VERSION + '...');
    console.log('üìå App Version:', APP_VERSION);
    console.log('üìå Config Version:', CONFIG.VERSION);
    
    try {
        // 1. Poƒçkat na Security Manager (prvn√≠, proto≈æe na nƒõm z√°vis√≠ ostatn√≠)
        if (window.security && !window.security.initialized) {
            console.log('‚è≥ Waiting for Security Manager...');
            await window.security.waitForInit();
            console.log('‚úÖ Security Manager ready');
        }
        
        // 2. Inicializovat Model Manager (druh√Ω, ale neinicializovat aktivn√≠ model)
        if (window.modelManager) {
            console.log('‚è≥ Preparing Model Manager...');
            // Model Manager pot≈ôebujeme, ale nechceme ho plnƒõ inicializovat
            // proto≈æe je≈°tƒõ nem√°me naƒçten√© modely
            console.log('‚úÖ Model Manager ready for model registration');
        }
        
        // 3. Inicializovat Model Loader (t≈ôet√≠, naƒçte a zaregistruje modely)
        if (window.modelLoader) {
            console.log('‚è≥ Initializing Model Loader...');
            await window.modelLoader.initialize();
            console.log('‚úÖ Model Loader ready');
        }
        
        // 4. Nyn√≠ inicializovat Model Manager (po naƒçten√≠ model≈Ø)
        if (window.modelManager) {
            console.log('‚è≥ Initializing Model Manager...');
            await window.modelManager.initialize();
            console.log('‚úÖ Model Manager ready');
        }
        
        // 5. Validovat konfiguraci
        if (window.modelManager) {
            const issues = await window.modelManager.validateConfiguration();
            if (issues.length > 0) {
                console.warn('‚ö†Ô∏è Configuration issues:');
                issues.forEach(issue => {
                    console.warn(`  - [${issue.type}] ${issue.message}`);
                });
            }
            
            // Zobrazit dostupn√© modely
            const models = window.modelManager.getAvailableModelsSync();
            console.log('ü§ñ Available models:', models.length);
            if (CONFIG.DEBUG_MODE) {
                models.forEach(m => {
                    console.log(`  - ${m.name} (${m.id}) ${m.hasApiKey ? '‚úÖ' : '‚ùå'}`);
                });
            }
            
            // Zobrazit aktivn√≠ model
            const activeModel = window.modelManager.getModelInfoSync();
            if (activeModel) {
                console.log('‚úÖ Active model:', activeModel.name);
            } else {
                console.warn('‚ö†Ô∏è No active model');
            }
        }
        
        // 6. Debug mode
        if (CONFIG.DEBUG_MODE) {
            console.log('üêõ Debug mode is ON');
            window.debugInfo = {
                app: window.chatSystem,
                security: window.security,
                modelManager: window.modelManager,
                modelLoader: window.modelLoader,
                uiManager: window.uiManager,
                settingsManager: window.settingsManager,
                // Debug funkce
                getState: () => ({
                    messages: messages.length,
                    rateLimitCounter: rateLimitCounter,
                    initialized: window.modelManager?.initialized,
                    activeModel: window.modelManager?.getActiveModel()?.id,
                    visibleModels: window.modelManager?.getAvailableModelsSync().length
                }),
                // Test funkce - roz≈°√≠≈ôen√° pro v≈°echny providery
                testApiKeys: async () => {
                    const providers = ['openai', 'anthropic', 'google', 'perplexity', 'together', 'cohere'];
                    for (const provider of providers) {
                        const hasKey = await window.modelManager?.checkApiKey(provider);
                        console.log(`${provider}: ${hasKey ? '‚úÖ configured' : '‚ùå missing'}`);
                    }
                }
            };
        }
        
        console.log('‚úÖ MyConnectAI v' + APP_VERSION + ' ready');
        
    } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        
        // Zobrazit user-friendly chybu
        if (window.uiManager) {
            window.uiManager.addMessage('error', 
                'Chyba p≈ôi inicializaci aplikace. Zkuste obnovit str√°nku.'
            );
        } else {
            // Fallback alert pokud UI nen√≠ dostupn√©
            alert('Kritick√° chyba p≈ôi naƒç√≠t√°n√≠ aplikace. Pros√≠m obnovte str√°nku.');
        }
    }
}

// Promise-based ƒçek√°n√≠ na komponenty
function waitForComponents() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50; // 10 sekund max
        
        const checkInterval = setInterval(() => {
            attempts++;
            
            const requiredComponents = {
                'CONFIG': window.CONFIG,
                'Security': window.security,
                'Models Registry': window.MODELS_REGISTRY,
                'Models Registry Helper': window.ModelsRegistryHelper,
                'OpenAI Model': window.OpenAIModel,
                'Model Manager': window.modelManager,
                'Model Loader': window.modelLoader,
                'UI Manager': window.uiManager,
                'Settings Manager': window.settingsManager
            };
            
            const missingComponents = Object.entries(requiredComponents)
                .filter(([name, component]) => !component)
                .map(([name]) => name);
            
            if (missingComponents.length === 0) {
                clearInterval(checkInterval);
                console.log('‚úÖ All components loaded');
                resolve();
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                console.error('‚ùå Failed to load components:', missingComponents);
                reject(new Error(`Missing components: ${missingComponents.join(', ')}`));
            } else if (attempts % 10 === 0) {
                console.log(`‚è≥ Waiting for: ${missingComponents.join(', ')} (${attempts}/${maxAttempts})`);
            }
        }, 200);
    });
}

// Spu≈°tƒõn√≠ aplikace
window.addEventListener('load', async function() {
    console.log('üåü Window loaded, starting initialization...');
    
    try {
        // Poƒçkat na naƒçten√≠ v≈°ech komponent
        await waitForComponents();
        
        // Mal√© zpo≈ædƒõn√≠ pro jistotu
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Spustit inicializaci
        await initApp();
        
    } catch (error) {
        console.error('‚ùå Failed to start application:', error);
        alert(`Chyba p≈ôi naƒç√≠t√°n√≠ aplikace: ${error.message}\n\nPros√≠m obnovte str√°nku.`);
    }
});

// Glob√°ln√≠ error handler
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    
    // Nezobrazovat chyby z external skript≈Ø
    if (event.filename && !event.filename.includes(window.location.host)) {
        return;
    }
    
    // Log do konzole pro debugging
    if (CONFIG.DEBUG_MODE) {
        console.error('Error details:', {
            message: event.message,
            filename: event.filename,
            line: event.lineno,
            column: event.colno,
            error: event.error
        });
    }
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    
    // V debug modu zobrazit v√≠ce informac√≠
    if (CONFIG.DEBUG_MODE) {
        console.error('Promise rejection details:', event);
    }
});

// Window unload handler - cleanup v≈°ech komponent
window.addEventListener('beforeunload', () => {
    console.log('üßπ Cleaning up before unload...');
    
    try {
        // Cleanup v≈°ech manager≈Ø
        if (window.uiManager && window.uiManager.destroy) {
            window.uiManager.destroy();
        }
        
        if (window.settingsManager && window.settingsManager.cleanup) {
            window.settingsManager.cleanup();
        }
        
        if (window.modelManager && window.modelManager.destroy) {
            window.modelManager.destroy();
        }
        
        // Vyƒçistit timery
        if (rateLimitTimer) {
            clearTimeout(rateLimitTimer);
        }
        
        console.log('‚úÖ Cleanup completed');
    } catch (error) {
        console.error('Error during cleanup:', error);
    }
});

// Export pro glob√°ln√≠ p≈ô√≠stup
window.chatSystem = {
    messages: messages,
    sendMessage: sendMessage,
    clearChat: clearChat,
    version: APP_VERSION,
    // Debug funkce
    getState: () => ({
        messages: messages.length,
        rateLimitCounter: rateLimitCounter,
        initialized: window.modelManager?.initialized
    })
};

// Zachov√°n√≠ kompatibility
window.sendMessage = sendMessage;

console.log('üì¶ Main.js loaded (MyConnectAI v' + APP_VERSION + ')');
